<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juzgado de Ejecución Penal de Segunda Nominación de la Prov. de Catamarca, Rep. Argentina</title>
    <!-- Scripts de la API de Google -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        /* --- ESTILOS GENERALES Y FUENTE --- */
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-sizing: border-box;
        }
        
        /* --- FONDO Y CUERPO DE LA PÁGINA --- */
        body {
            background: linear-gradient(135deg, #2c3e50, #34495e); /* Gradiente más sutil y moderno */
            min-height: 100vh;
            padding: 20px;
            color: #333;
            display: flex;
            justify-content: center;
            /* Se elimina align-items: center para que el contenido comience desde arriba */
        }
        
        /* --- CONTENEDOR PRINCIPAL CON EFECTO 3D --- */
        .container {
            width: 100%;
            max-width: 900px;
            margin: 20px;
            background: #ffffff;
            border-radius: 20px; /* Bordes más redondeados */
            box-shadow: 0 20px 50px rgba(0,0,0,0.4), 0 0 0 2px rgba(255,255,255,0.1); /* Sombra más pronunciada para efecto 3D */
            overflow: hidden;
            transform: perspective(1200px); /* Perspectiva para transformaciones 3D */
            transition: transform 0.4s ease;
        }
        .container:hover {
            transform: scale(1.01); /* Ligero zoom al pasar el mouse */
        }
        
        /* --- ENCABEZADO CON LOGO Y TÍTULO --- */
        .header {
            background: linear-gradient(90deg, #003366, #005cb3);
            color: white;
            padding: 20px 40px; /* Ajuste de padding */
            text-align: center;
            position: relative; /* Necesario para posicionar el logo */
            border-bottom: 5px solid #fdbb2d;
            min-height: 120px; /* Altura mínima para asegurar espacio */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .header-logo {
            position: absolute;
            top: 50%;
            left: 40px;
            transform: translateY(-50%);
            width: 80px; /* Tamaño del logo */
            height: auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            padding: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }
        /* Contenedor para el texto del encabezado para gestionar el espaciado */
        .header-text-container {
            padding-left: 100px; /* Espacio para que no choque con el logo */
            padding-right: 40px;
        }
        
        .header h1 {
            margin: 0 0 5px 0;
            font-size: 1.5rem; /* Ajuste de tamaño para el título largo */
            font-weight: 500;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .header p {
            margin: 0;
            opacity: 1;
            font-size: 2rem; /* Tamaño más grande para "Cómputo de Pena" */
            font-weight: bold;
            text-shadow: 0 3px 8px rgba(0,0,0,0.5);
            letter-spacing: 1px;
        }
        
        /* --- CONTENIDO PRINCIPAL --- */
        .content {
            padding: 30px;
        }
        
        /* --- SECCIONES DEL FORMULARIO CON EFECTO HOVER --- */
        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            border: none; /* Quitamos el borde */
            border-radius: 15px;
            background: #f9fafb;
            box-shadow: 0 5px 15px rgba(0,0,0,0.07); /* Sombra sutil */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .form-section:hover {
            transform: translateY(-5px); /* Se eleva al pasar el mouse */
            box-shadow: 0 12px 25px rgba(0,0,0,0.1);
        }
        
        .form-section h2 {
            margin-top: 0;
            color: #003366;
            border-bottom: 2px solid #005cb3;
            padding-bottom: 10px;
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 1rem;
        }
        
        /* --- INPUTS Y SELECTS MODERNOS --- */
        input,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #0066cc;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2); /* Resplandor al enfocar */
        }
        
        .periodo-detencion {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .periodo-detencion input {
            flex: 1;
        }
        
        /* --- BOTONES CON EFECTO 3D --- */
        .btn {
            background: linear-gradient(145deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 91, 179, 0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            background: linear-gradient(145deg, #0069d9, #004a99);
            transform: translateY(-3px) scale(1.05); /* Efecto de elevación y crecimiento */
            box-shadow: 0 7px 15px rgba(0, 91, 179, 0.4);
        }
        .btn:active {
            transform: translateY(-1px) scale(1.02); /* Efecto de presionar */
        }
        
        .btn-danger {
            background: linear-gradient(145deg, #dc3545, #b02a37);
            box-shadow: 0 4px 10px rgba(176, 42, 55, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(145deg, #c82333, #a12430);
            box-shadow: 0 7px 15px rgba(176, 42, 55, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(145deg, #28a745, #1e7e34);
            font-size: 1.3rem;
            padding: 15px 30px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(30, 126, 52, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(145deg, #218838, #19692c);
            box-shadow: 0 7px 15px rgba(30, 126, 52, 0.4);
        }
        
        .btn-pdf {
            background: linear-gradient(145deg, #8e44ad, #7d3c98);
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(125, 60, 152, 0.3);
        }
        
        .btn-pdf:hover {
            background: linear-gradient(145deg, #803ea5, #6d3284);
            box-shadow: 0 7px 15px rgba(125, 60, 152, 0.4);
        }
        
        /* --- SECCIÓN DE RESULTADOS --- */
        .resultados {
            margin-top: 30px;
            padding: 25px;
            background: #eef2f7;
            border-radius: 15px;
            border-left: 6px solid #005cb3;
        }
        
        .resultados h2 {
            color: #003366;
            margin-top: 0;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .resultados h3 {
            color: #003366;
            font-size: 1.4rem;
            margin-top: 25px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .resultado-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            font-size: 1.05rem;
            border-left: 4px solid transparent;
            transition: border-color 0.3s;
        }
        .resultado-item:hover {
            border-left-color: #007bff;
        }
        
        .resultado-item strong {
            color: #003366;
            font-weight: 600;
            font-size: 1.1rem;
            margin-right: 8px;
        }
        
        .beneficio-item {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .alerta-item {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .error-item {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        /* --- PIE DE PÁGINA --- */
        .footer {
            background: #2c3e50;
            color: rgba(255,255,255,0.8);
            text-align: center;
            padding: 20px;
            border-top: 5px solid #fdbb2d;
        }
        
        .footer p {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .hidden {
            display: none;
        }
        
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-size: 1rem;
            color: #0c5460;
        }
        /* --- ESTILOS PARA EL MODAL DE CONFIRMACIÓN --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content h3 {
            margin-top: 0;
            color: #333;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* --- NUEVOS ESTILOS: PESTAÑAS (TABS) --- */
        .auth-section {
            padding: 20px;
            background: #f9fafb;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.07);
        }
        #authStatus {
            font-weight: 600;
            color: #003366;
            margin-top: 15px;
        }

        .tabs {
            display: flex;
            border-bottom: 3px solid #005cb3;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.2rem;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
        }
        .tab-btn.active {
            color: #005cb3;
            border-bottom-color: #005cb3;
        }
        .tab-btn:not(.active):hover {
            background-color: #f9fafb;
        }
        .tab-panel {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- NUEVOS ESTILOS: TABLA DE HISTORIAL (MEJORADA) --- */
        
        /* Controles de la tabla (búsqueda, exportar) */
        .historial-controles {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        #filtroNombre {
            flex: 1; /* El campo de búsqueda ocupa el espacio disponible */
            min-width: 250px;
        }
        
        /* Contenedor de la tabla con scroll */
        .historial-container {
            overflow-x: auto; /* Scroll horizontal en pantallas chicas */
            overflow-y: auto; /* NUEVO: Scroll vertical */
            max-height: 500px; /* NUEVO: Altura máxima para la tabla */
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .historial-table {
            width: 100%;
            border-collapse: collapse;
            /* margin-top: 20px; */ /* Eliminado, ahora el contenedor tiene el margen */
        }
        .historial-table th, .historial-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            font-size: 0.95rem;
            white-space: nowrap; /* Evita que el texto largo rompa las celdas */
        }
        .historial-table th {
            background-color: #eef2f7;
            color: #003366;
            font-weight: 700;
            position: sticky; /* Encabezados fijos */
            top: 0;
        }
        .historial-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .historial-table tr:hover {
            background-color: #f1f5f9;
        }

        /* --- RESPONSIVIDAD --- */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 20px;
            }
            .header-logo {
                position: static; /* Cambia a estático en móvil */
                transform: none;
                margin-bottom: 15px;
                width: 70px;
            }
            .header-text-container {
                padding-left: 0; /* Sin padding en móvil */
                padding-right: 0;
            }
            .header h1 {
                font-size: 1.2rem;
            }
            .header p {
                font-size: 1.8rem;
            }
            .content {
                padding: 20px;
            }
            .periodo-detencion {
                flex-direction: column;
                gap: 10px;
            }
            .tabs {
                flex-wrap: wrap;
            }
            .tab-btn {
                width: 50%;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo-poder-judicial.jpeg" alt="Logo Poder Judicial de Catamarca" class="header-logo">
            <div class="header-text-container">
                <h1>Juzgado de Ejecución Penal de Segunda Nominación de la Prov. de Catamarca, Rep. Argentina</h1>
                <p>Cómputo de Pena</p>
            </div>
        </div>
        
        <div class="content">
            
            <!-- NUEVA SECCIÓN: AUTENTICACIÓN -->
            <div class="auth-section">
                <button id="btnAuthorize" class="btn">Iniciar Sesión para Guardar o Ver Historial</button>
                <div id="authStatus" class="hidden"></div>
            </div>

            <!-- NUEVA SECCIÓN: PESTAÑAS -->
            <div class="tabs">
                <button id="tabCalculadora" class="tab-btn active">Calculadora</button>
                <button id="tabHistorial" class="tab-btn hidden">Historial</button>
            </div>

            <!-- PESTAÑA 1: CALCULADORA (CONTENIDO EXISTENTE) -->
            <div id="panelCalculadora" class="tab-panel">
                <div class="info-box">
                    <strong>Información importante:</strong> Esta calculadora aplica la legislación vigente en Argentina (Ley 24.660 y modificaciones).
                </div>
                
                <form id="condenaForm">
                    <div class="form-section">
                        <h2>Datos Personales</h2>
                        
                        <div class="form-group">
                            <label for="nombreCondenado">Nombre del condenado:</label>
                            <input type="text" id="nombreCondenado" placeholder="Apellido y Nombre" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="delito">Delito:</label>
                            <input type="text" id="delito" placeholder="Descripción del delito" required>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h2>Datos de la Condena</h2>
                        
                        <div class="form-group">
                            <label for="tipoCondena">Tipo de condena:</label>
                            <select id="tipoCondena" required>
                                <option value="">Seleccione...</option>
                                <option value="temporal">Prisión efectiva temporal</option>
                                <option value="perpetua">Prisión efectiva perpetua</option>
                            </select>
                        </div>
                        
                        <div id="penaTemporal" class="form-group hidden">
                            <label for="penaImpuesta">Pena impuesta (años, meses, días):</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="penaAnos" placeholder="Años" min="0">
                                <input type="number" id="penaMeses" placeholder="Meses" min="0" max="11">
                                <input type="number" id="penaDias" placeholder="Días" min="0" max="30">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="fechaInicioCondena">Fecha de inicio de condena:</label>
                            <input type="date" id="fechaInicioCondena" required>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h2>Detenciones Preventivas</h2>
                        <p>Ingrese los períodos de detención previos a la condena (si corresponde):</p>
                        
                        <div id="detencionesContainer">
                            <!-- Este contenedor estará vacío inicialmente -->
                        </div>
                        
                        <button type="button" class="btn" onclick="agregarPeriodo()">+ Agregar período</button>
                    </div>
                    
                    <div class="form-section">
                        <h2>Datos del Hecho</h2>
                        
                        <div class="form-group">
                            <label for="fechaHecho">Fecha del hecho:</label>
                            <input type="date" id="fechaHecho" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="tipoDelito">Tipo de delito (para beneficios):</label>
                            <select id="tipoDelito" required>
                                <option value="">Seleccione...</option>
                                <option value="56bis">Delito del Art. 14 CP / Art. 56 bis LEP</option>
                                <option value="otro">Otro delito</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="reincidente">¿Es reincidente (Art. 50 CP)?</label>
                            <select id="reincidente" required>
                                <option value="">Seleccione...</option>
                                <option value="si">Sí</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">Calcular Condena</button>
                </form>
                
                <div id="resultados" class="resultados hidden">
                    <h2>Informe de Cómputo de Condena</h2>
                    <div id="resultadosContainer"></div>
                    <button id="btnPDF" class="btn btn-pdf">Generar PDF para Imprimir</button>
                    <button id="btnGuardarSheets" class="btn" style="background: linear-gradient(145deg, #28a745, #1e7e34);">Guardar en Google Sheets</button>
                    <div id="auth-status-save" style="margin-top: 15px; font-weight: 500;"></div>
                </div>
            </div>

            <!-- PESTAÑA 2: HISTORIAL (NUEVA Y MEJORADA) -->
            <div id="panelHistorial" class="tab-panel hidden">
                <div class="form-section">
                    <h2>Historial de Cómputos</h2>
                    <p>Mostrando todos los cómputos guardados en la hoja de Google Sheets.</p>
                    
                    <!-- NUEVOS CONTROLES DE HISTORIAL -->
                    <div class="historial-controles">
                        <input type="text" id="filtroNombre" placeholder="Buscar por nombre...">
                        <button id="btnExportarCSV" class="btn">Exportar a CSV</button>
                        <button id="btnRefrescarHistorial" class="btn">Refrescar</button>
                    </div>

                    <div id="historialSpinner" class="hidden" style="margin-top: 20px;">Cargando...</div>
                    
                    <!-- CONTENEDOR DE TABLA MEJORADO CON SCROLL -->
                    <div class="historial-container" style="margin-top: 20px;">
                        <table id="historialTable" class="historial-table">
                            <!-- El contenido se generará dinámicamente -->
                        </table>
                    </div>
                </div>
            </div>

        </div>
        
        <div class="footer">
            <p>Create by RBM 2025</p>
        </div>
    </div>
    <!-- Modal de Confirmación -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirmación</h3>
            <p id="modalMessage">¿Está seguro de que desea guardar estos datos en Google Sheets?</p>
            <div class="modal-buttons">
                <button id="confirmBtn" class="btn btn-success">Sí, guardar</button>
                <button id="cancelBtn" class="btn btn-danger">Cancelar</button>
            </div>
        </div>
    </div>
    <script>
        // --- NUEVA CONSTANTE DE ADMINISTRADOR (ACTUALIZADA) ---
        // !!! Email de administrador configurado
        const ADMIN_EMAIL = "rubenmilstein77@gmail.com"; 

        // --- VARIABLES GLOBALES PARA LA API DE GOOGLE ---
        const CLIENT_ID = '110247006601-hvbpfqcd0v79tgmiqr9ntc853t9a1vu3.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1ASWYg5AZbm1AD5h9cQjxZK00Q8RebiuQo3daBYJnj64';
        const DISCOVERY_DOC_SHEETS = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const DISCOVERY_DOC_OAUTH = 'https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let lastResults = null; // Variable para guardar los últimos resultados calculados
        let historialData = []; // NUEVO: Almacena los datos del historial para filtrar y exportar

        document.addEventListener('DOMContentLoaded', function() {
            // Eventos del formulario y botones
            document.getElementById('condenaForm').addEventListener('submit', calcularCondena);
            document.getElementById('tipoCondena').addEventListener('change', togglePenaTemporal);
            
            // Eventos de botones de acción
            document.getElementById('btnPDF').addEventListener('click', generarPDF);
            document.getElementById('btnGuardarSheets').addEventListener('click', () => {
                mostrarConfirmacion('¿Está seguro de que desea guardar estos datos en Google Sheets?', guardarEnSheets);
            });
            
            // Eventos del modal
            document.getElementById('cancelBtn').addEventListener('click', ocultarConfirmacion);
            document.getElementById('confirmationModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    ocultarConfirmacion();
                }
            });

            // --- NUEVOS EVENTOS: TABS, AUTENTICACIÓN Y FILTROS ---
            document.getElementById('btnAuthorize').addEventListener('click', handleAuthClick);
            document.getElementById('tabCalculadora').addEventListener('click', () => switchTab('Calculadora'));
            // --- CORRECCIÓN DE ERROR ---
            // Corregido 'tabHistORIAL' a 'tabHistorial'
            document.getElementById('tabHistorial').addEventListener('click', () => switchTab('Historial'));
            document.getElementById('btnRefrescarHistorial').addEventListener('click', cargarHistorial);

            // NUEVOS: Eventos de búsqueda y exportación
            document.getElementById('filtroNombre').addEventListener('input', filtrarTabla);
            document.getElementById('btnExportarCSV').addEventListener('click', exportarACSV);
        });

        // --- FUNCIONES DE LA API DE GOOGLE (MODIFICADAS) ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            // Se inicializan AMBAS APIs: sheets y oauth2
            await gapi.client.init({
                discoveryDocs: [DISCOVERY_DOC_SHEETS, DISCOVERY_DOC_OAUTH],
            });
            gapiInited = true;
            maybeEnableButtons();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: tokenCallback, // Callback unificado
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            // Habilita el botón principal de Iniciar Sesión
            if (gapiInited && gisInited) {
                document.getElementById('btnAuthorize').disabled = false;
            }
        }

        // Función principal de autenticación
        function handleAuthClick() {
            if (gapi.client.getToken() === null) {
                // Si no hay token, solicitar uno (iniciar sesión)
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                // Si ya hay token, forzar un refresco
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // Callback unificado cuando se obtiene un token
        async function tokenCallback(resp) {
            if (resp.error !== undefined) {
                document.getElementById('authStatus').innerText = 'Error de autenticación. Intente de nuevo.';
                throw (resp);
            }
            // 1. Ocultar botón de login, mostrar estado
            document.getElementById('btnAuthorize').classList.add('hidden');
            document.getElementById('authStatus').classList.remove('hidden');
            document.getElementById('authStatus').innerText = 'Estado: Autenticado. Verificando usuario...';

            // 2. Obtener email del usuario
            try {
                const userInfo = await gapi.client.oauth2.userinfo.get();
                const email = userInfo.result.email;
                
                if (email) {
                    document.getElementById('authStatus').innerText = `Usuario: ${email}`;
                    // 3. Verificar si es Administrador
                    checkAdmin(email);
                } else {
                    document.getElementById('authStatus').innerText = 'Error al obtener email del usuario.';
                }
            } catch (e) {
                console.error("Error fetching user info", e);
                document.getElementById('authStatus').innerText = 'Error al verificar el usuario.';
            }
        }

        // --- NUEVAS FUNCIONES: ADMIN, PESTAÑAS Y FILTROS ---

        // Muestra funciones de admin si el email coincide
        function checkAdmin(email) {
            if (email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('tabHistorial').classList.remove('hidden');
                document.getElementById('authStatus').innerText += ' (ADMINISTRADOR)';
            } else {
                document.getElementById('tabHistorial').classList.add('hidden');
                document.getElementById('authStatus').innerText += ' (Usuario Estándar)';
            }
        }

        // Cambia entre la pestaña Calculadora y Historial
        function switchTab(tabName) {
            if (tabName === 'Calculadora') {
                document.getElementById('tabCalculadora').classList.add('active');
                document.getElementById('tabHistorial').classList.remove('active');
                
                document.getElementById('panelCalculadora').classList.remove('hidden');
                document.getElementById('panelHistorial').classList.add('hidden');
            } else if (tabName === 'Historial') {
                document.getElementById('tabCalculadora').classList.remove('active');
                document.getElementById('tabHistorial').classList.add('active');
                
                document.getElementById('panelCalculadora').classList.add('hidden');
                document.getElementById('panelHistorial').classList.remove('hidden');
                
                // Cargar el historial al cambiar a la pestaña
                cargarHistorial();
            }
        }

        // Carga los datos desde Google Sheets
        async function cargarHistorial() {
            const spinner = document.getElementById('historialSpinner');
            const table = document.getElementById('historialTable');
            table.innerHTML = ''; // Limpiar tabla
            historialData = []; // Limpiar datos en memoria
            spinner.classList.remove('hidden');
            spinner.innerText = 'Cargando...';

            // Verificar autenticación
            if (gapi.client.getToken() === null) {
                spinner.innerText = 'Error: Debe iniciar sesión para ver el historial.';
                return;
            }

            try {
                // Rango de lectura (A:K) basado en los 11 campos que guardamos
                const range = "'Hoja 1'!A:K";
                
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                });
                
                spinner.classList.add('hidden');
                const values = response.result.values;

                if (values && values.length > 0) {
                    historialData = values; // Guardar datos en memoria
                    renderHistorialTabla(values); // Dibujar la tabla
                } else {
                    table.innerHTML = '<tbody><tr><td>No se encontraron datos en el historial.</td></tr></tbody>';
                }

            } catch (reason) {
                console.error('Error al cargar historial:', reason);
                spinner.classList.remove('hidden');
                let errorMessage = 'Error al cargar el historial. Revise la consola.';
                if (reason.result && reason.result.error && reason.result.error.status === 'PERMISSION_DENIED') {
                    errorMessage = 'Error: Permiso denegado. Asegúrese de tener permiso para LEER la hoja de cálculo.';
                }
                spinner.innerText = errorMessage;
            }
        }

        // NUEVA FUNCIÓN: Dibuja la tabla del historial
        function renderHistorialTabla(data) {
            const table = document.getElementById('historialTable');
            // Crear encabezado de la tabla
            const a_headers = [
                "Nombre", "Delito", "Fecha Hecho", "Reincidente", "Condena",
                "Pena Total", "Abono", "Pena Efectiva", "Fin Condena", 
                "Beneficios", "Fecha Guardado"
            ];
            let thead = '<thead><tr>';
            a_headers.forEach(h => thead += `<th>${h}</th>`);
            thead += '</tr></thead>';
            
            // Crear cuerpo de la tabla (en orden reverso para ver los más nuevos primero)
            let tbody = '<tbody>';
            data.slice().reverse().forEach(row => {
                tbody += '<tr>';
                // Asegurarse de que hay 11 celdas
                for (let i = 0; i < a_headers.length; i++) {
                    tbody += `<td>${row[i] || ''}</td>`;
                }
                tbody += '</tr>';
            });
            tbody += '</tbody>';
            
            table.innerHTML = thead + tbody;
            
            // Re-aplicar el filtro actual después de renderizar
            filtrarTabla();
        }

        // NUEVA FUNCIÓN: Filtra la tabla por nombre en tiempo real
        function filtrarTabla() {
            const filtro = document.getElementById('filtroNombre').value.toLowerCase();
            const tabla = document.getElementById('historialTable');
            const tbody = tabla.getElementsByTagName('tbody')[0];
            if (!tbody) return;
            
            const filas = tbody.getElementsByTagName('tr');

            for (let i = 0; i < filas.length; i++) {
                const celdaNombre = filas[i].getElementsByTagName('td')[0]; // Columna 0 = Nombre
                if (celdaNombre) {
                    const textoCelda = (celdaNombre.textContent || celdaNombre.innerText).toLowerCase();
                    if (textoCelda.indexOf(filtro) > -1) {
                        filas[i].style.display = "";
                    } else {
                        filas[i].style.display = "none";
                    }
                }
            }
        }

        // NUEVA FUNCIÓN: Exporta los datos del historial a CSV
        function exportarACSV() {
            if (historialData.length === 0) {
                alert("No hay datos en el historial para exportar.");
                return;
            }

            const headers = [
                "Nombre", "Delito", "Fecha Hecho", "Reincidente", "Condena",
                "Pena Total", "Abono", "Pena Efectiva", "Fin Condena", 
                "Beneficios", "Fecha Guardado"
            ];
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Agregar encabezados
            csvContent += headers.join(",") + "\r\n";

            // Agregar filas
            historialData.forEach(rowArray => {
                const row = rowArray.map(cell => {
                    let cellData = (cell || '').toString();
                    // Escapar comillas dobles duplicándolas
                    cellData = cellData.replace(/"/g, '""');
                    // Poner comillas si el dato contiene comas, saltos de línea o comillas
                    if (cellData.search(/("|,|\n)/g) >= 0) {
                        cellData = `"${cellData}"`;
                    }
                    return cellData;
                });
                csvContent += row.join(",") + "\r\n";
            });

            // Crear y descargar el archivo
            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "historial_computos.csv");
            document.body.appendChild(link); // Requerido para Firefox
            link.click();
            document.body.removeChild(link);
        }

        // --- FUNCIÓN DE GUARDAR (MODIFICADA) ---
        function guardarEnSheets() {
            if (!lastResults) {
                document.getElementById('auth-status-save').innerText = 'Error: Primero debe calcular una condena.';
                return;
            }
            // Verificar si el token existe
            if (gapi.client.getToken() === null) {
                document.getElementById('auth-status-save').innerText = 'Error: Debe Iniciar Sesión antes de guardar.';
                // Intentar autenticar
                handleAuthClick();
                return;
            }

            // (El resto de la lógica de guardado es idéntica a la versión anterior)
            const beneficiosTexto = lastResults.beneficios.map(b => `${b.tipo}: ${b.fecha}`).join('; ') || 'No aplica';
            const datosFila = [
                lastResults.nombreCondenado,
                lastResults.delito,
                lastResults.fechaHecho,
                lastResults.reincidente ? 'Sí' : 'No',
                lastResults.tipoCondena === 'temporal' ? 'Prisión efectiva temporal' : 'Prisión efectiva perpetua',
                convertirDiasAMDM(lastResults.penaTotalDias),
                `${lastResults.penaTotalDias - lastResults.penaEfectivaDias} días`, // Abono
                convertirDiasAMDM(lastResults.penaEfectivaDias),
                lastResults.fechaFinCondena,
                beneficiosTexto,
                new Date().toLocaleString('es-AR') // Fecha de guardado
            ];
            
            const request = {
                spreadsheetId: SPREADSHEET_ID,
                range: "'Hoja 1'!A1",
                valueInputOption: 'USER_ENTERED',
                resource: {
                    values: [datosFila]
                }
            };
            
            const authStatusSave = document.getElementById('auth-status-save');
            authStatusSave.innerText = 'Guardando...';

            gapi.client.sheets.spreadsheets.values.append(request).then(function(response) {
                authStatusSave.innerText = '¡Datos guardados con éxito!';
            }, function(reason) {
                console.error('Error al guardar:', reason);
                let errorMessage = 'Error al guardar. Revise la consola para más detalles.';
                if (reason.result && reason.result.error) {
                    const error = reason.result.error;
                    if (error.status === 'NOT_FOUND') {
                        errorMessage = "Error: No se encontró la hoja de cálculo. Verifique que el 'SPREADSHEET_ID' sea correcto.";
                    } else if (error.status === 'PERMISSION_DENIED') {
                        errorMessage = "Error: Permiso denegado. Asegúrese de tener permiso para editar la hoja de cálculo.";
                    } else if (error.message && error.message.includes('Unable to parse range')) {
                        errorMessage = "Error: No se encontró la pestaña. Verifique que el nombre de la pestaña sea exactamente 'Hoja 1'.";
                    } else {
                        errorMessage = `Error: ${error.message}`;
                    }
                }
                authStatusSave.innerText = errorMessage;
            });
        }
        
        // --- FUNCIONES DEL MODAL (Sin cambios) ---
        function mostrarConfirmacion(message, callback) {
            document.getElementById('modalMessage').textContent = message;
            const modal = document.getElementById('confirmationModal');
            modal.classList.add('visible');
            const confirmBtn = document.getElementById('confirmBtn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                callback();
                ocultarConfirmacion();
            });
        }
        function ocultarConfirmacion() {
            document.getElementById('confirmationModal').classList.remove('visible');
        }
        
        // --- FUNCIONES DE LA CALCULADORA (Sin cambios) ---
        function togglePenaTemporal() {
            const tipoCondena = document.getElementById('tipoCondena').value;
            const penaTemporalDiv = document.getElementById('penaTemporal');
            
            if (tipoCondena === 'temporal') {
                penaTemporalDiv.classList.remove('hidden');
                document.getElementById('penaAnos').required = true;
                document.getElementById('penaMeses').required = true;
                document.getElementById('penaDias').required = true;
            } else {
                penaTemporalDiv.classList.add('hidden');
                document.getElementById('penaAnos').required = false;
                document.getElementById('penaMeses').required = false;
                document.getElementById('penaDias').required = false;
            }
        }
        
        function agregarPeriodo() {
            const container = document.getElementById('detencionesContainer');
            const nuevoPeriodo = document.createElement('div');
            nuevoPeriodo.className = 'periodo-detencion';
            nuevoPeriodo.innerHTML = `
                <input type="date" placeholder="Fecha inicio" class="fechaInicio" required>
                <input type="date" placeholder="Fecha fin" class="fechaFin" required>
                <button type="button" class="btn btn-danger" onclick="eliminarPeriodo(this)">Eliminar</button>
            `;
            container.appendChild(nuevoPeriodo);
        }
        
        function eliminarPeriodo(boton) {
            boton.parentElement.remove();
        }
        
        function convertirDiasAMDM(dias) {
            if (dias < 0) dias = 0;
            const años = Math.floor(dias / 365.25);
            const resto = dias % 365.25;
            const meses = Math.floor(resto / 30.44);
            const diasRestantes = Math.round(resto % 30.44);
            
            let resultado = [];
            if (años > 0) {
                resultado.push(años + ' año' + (años !== 1 ? 's' : ''));
            }
            if (meses > 0) {
                resultado.push(meses + ' mes' + (meses !== 1 ? 'es' : ''));
            }
            if (diasRestantes > 0) {
                resultado.push(diasRestantes + ' día' + (diasRestantes !== 1 ? 's' : ''));
            }
            return resultado.join(', ') || '0 días';
        }
        
        function formatearFecha(fecha) {
            if (!fecha || !(fecha instanceof Date) || isNaN(fecha)) {
                return 'Fecha inválida';
            }
            const dia = fecha.getUTCDate().toString().padStart(2, '0');
            const mes = (fecha.getUTCMonth() + 1).toString().padStart(2, '0');
            const año = fecha.getUTCFullYear();
            return `${dia}/${mes}/${año}`;
        }
        function sumarDiasAFecha(fecha, dias) {
            const nuevaFecha = new Date(fecha);
            nuevaFecha.setUTCDate(nuevaFecha.getUTCDate() + dias);
            return nuevaFecha;
        }
        
        function sumarMesesAFecha(fecha, meses) {
            const nuevaFecha = new Date(fecha);
            nuevaFecha.setUTCMonth(nuevaFecha.getUTCMonth() + meses);
            return nuevaFecha;
        }
        
        function sumarAñosAFecha(fecha, años) {
            const nuevaFecha = new Date(fecha);
            nuevaFecha.setUTCFullYear(nuevaFecha.getUTCFullYear() + años);
            return nuevaFecha;
        }

        // --- NÚCLEO DE LA CALCULADORA (Lógica sin cambios) ---
        function calcularCondena(e) {
            e.preventDefault();
            lastResults = null; // Limpiar resultados previos

            // 1. LECTURA DE INPUTS
            const nombreCondenado = document.getElementById('nombreCondenado').value;
            const delito = document.getElementById('delito').value;
            const tipoCondena = document.getElementById('tipoCondena').value;
            const fechaInicioCondenaStr = document.getElementById('fechaInicioCondena').value;
            const fechaHechoStr = document.getElementById('fechaHecho').value;
            const tipoDelito = document.getElementById('tipoDelito').value;
            const reincidente = document.getElementById('reincidente').value;
            
            if (!fechaInicioCondenaStr || !fechaHechoStr) {
                const resultadosDiv = document.getElementById('resultados');
                const container = document.getElementById('resultadosContainer');
                container.innerHTML = `<div class="resultado-item error-item"><strong>Error:</strong> Por favor, complete todas las fechas requeridas en el formulario.</div>`;
                resultadosDiv.classList.remove('hidden');
                resultadosDiv.scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            // Forzar fechas a UTC para cálculos consistentes
            const fechaInicioCondena = new Date(fechaInicioCondenaStr + 'T00:00:00Z');
            const fechaHecho = new Date(fechaHechoStr + 'T00:00:00Z');
            
            // 2. CÁLCULOS BÁSICOS DE PENA Y ABONO
            let penaTotalDias = 0;
            let penaEfectivaDias = 0;
            let fechaFinCondena = null;
            let diasDetencionPreventiva = 0;
            
            if (tipoCondena === 'temporal') {
                const penaAnos = parseInt(document.getElementById('penaAnos').value) || 0;
                const penaMeses = parseInt(document.getElementById('penaMeses').value) || 0;
                const penaDias = parseInt(document.getElementById('penaDias').value) || 0;
                
                // Calcular fecha final "bruta" (sin abono)
                let fechaFinPenaBruta = new Date(fechaInicioCondena);
                fechaFinPenaBruta.setUTCFullYear(fechaFinPenaBruta.getUTCFullYear() + penaAnos);
                fechaFinPenaBruta.setUTCMonth(fechaFinPenaBruta.getUTCMonth() + penaMeses);
                fechaFinPenaBruta.setUTCDate(fechaFinPenaBruta.getUTCDate() + penaDias);
                
                // Calcular días de detención preventiva (abono)
                const periodosElements = document.querySelectorAll('.periodo-detencion');
                periodosElements.forEach(periodo => {
                    const fechaInicioStr = periodo.querySelector('.fechaInicio').value;
                    const fechaFinStr = periodo.querySelector('.fechaFin').value;
                    if (fechaInicioStr && fechaFinStr) {
                        const fechaInicio = new Date(fechaInicioStr + 'T00:00:00Z');
                        const fechaFin = new Date(fechaFinStr + 'T00:00:00Z');
                        if (fechaInicio <= fechaFin) {
                            const diffTime = Math.abs(fechaFin - fechaInicio);
                            // Usar Math.round para evitar el "día fantasma"
                            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                            diasDetencionPreventiva += diffDays;
                        }
                    }
                });
                
                // Calcular fecha final "neta" (con abono)
                fechaFinCondena = new Date(fechaFinPenaBruta);
                fechaFinCondena.setUTCDate(fechaFinCondena.getUTCDate() - diasDetencionPreventiva);
                
                // Calcular días totales de pena (para referencia)
                const diffPenaTotalMs = fechaFinPenaBruta.getTime() - fechaInicioCondena.getTime();
                penaTotalDias = Math.round(diffPenaTotalMs / (1000 * 60 * 60 * 24));
                if (penaTotalDias < 0) penaTotalDias = 0;
                
                // Calcular días efectivos de pena (para referencia)
                const diffPenaEfectivaMs = fechaFinCondena.getTime() - fechaInicioCondena.getTime();
                penaEfectivaDias = Math.round(diffPenaEfectivaMs / (1000 * 60 * 60 * 24));
                if (penaEfectivaDias < 0) penaEfectivaDias = 0;
            }
            
            // 3. LÓGICA DE BENEFICIOS (Sin cambios)
            let beneficios = [];
            let alertas = [];
            
            if (tipoCondena === 'perpetua') {
                alertas.push({
                    mensaje: 'Condena perpetua: No corresponde el acceso a beneficios',
                    tipo: 'error'
                });

            } else if (tipoCondena === 'temporal') {

                // Obtener pena original para comprobaciones
                const pAnos = parseInt(document.getElementById('penaAnos').value) || 0;
                const pMeses = parseInt(document.getElementById('penaMeses').value) || 0;
                const pDias = parseInt(document.getElementById('penaDias').value) || 0;

                // --- ¡NUEVA REGLA DE PENAS CORTAS (<= 3 MESES)! ---
                const totalMesesPena = pAnos * 12 + pMeses + (pDias / 30.44);

                if (totalMesesPena > 0 && totalMesesPena <= 3) {
                    
                    // REGLA ESPECIAL PARA PENAS CORTAS
                    const diasQuince = 15;
                    const diasRestantesParaQuince = diasQuince - diasDetencionPreventiva;
                    let fechaQuinceDias = sumarDiasAFecha(new Date(fechaInicioCondena), diasRestantesParaQuince);

                    beneficios.push({
                        tipo: 'Período de Prueba (Art. 17)',
                        fecha: formatearFecha(fechaQuinceDias)
                    });
                    beneficios.push({
                        tipo: 'Salidas Transitorias (Común)',
                        fecha: formatearFecha(fechaQuinceDias)
                    });
                    alertas.push({
                        mensaje: 'Pena corta (<= 3 meses): No aplica Libertad Condicional ni Asistida.',
                        tipo: 'alerta'
                    });

                } else {
                    
                    // --- LÓGICA ESTÁNDAR PARA PENAS > 3 MESES ---

                    // --- ¡NUEVA LÓGICA DE BIFURCACIÓN (ART 56 BIS / 2017)! ---
                    const fechaLimite2017 = new Date('2017-07-27T00:00:00Z');

                    // REGLA 1: Delito 56bis Y Hecho POSTERIOR a 2017
                    if (tipoDelito === '56bis' && fechaHecho > fechaLimite2017) {
                        
                        // --- REGLA 1: DELITO GRAVE (Art. 56 quater) ---
                        // No tiene ningún beneficio, solo el régimen preparatorio.
                        
                        const fechaRegimenPrep = sumarAñosAFecha(new Date(fechaFinCondena), -2);
                        beneficios.push({
                            tipo: 'Régimen Preparatorio (Art. 56 quater)',
                            fecha: formatearFecha(fechaRegimenPrep)
                        });
                        alertas.push({
                            mensaje: 'Delito Art. 56 bis (hecho post 27/07/2017): No aplican otros beneficios.',
                            tipo: 'alerta'
                        });

                    } else {
                        
                        // --- REGLA 2: DELITO COMÚN (cualquier fecha) O Delito 56bis ANTERIOR a 2017 ---
                        // Se calculan los beneficios de forma estándar.
                        
                        // Fecha límite para Período de Prueba y L. Asistida (Regla 2015)
                        const fechaLimite2015 = new Date('2015-07-27T00:00:00Z'); 
                        const esHechoPosterior2015 = fechaHecho > fechaLimite2015;

                        // --- 1. CÁLCULO DE FECHAS CLAVE (CON ABONO YA RESTADO) ---
                        
                        // A. Mitad de la Pena (50%) - Método Años/Meses
                        const totalMesesBrutos = pAnos * 12 + pMeses;
                        const mitadTotalMesesBrutos = totalMesesBrutos / 2;
                        const anosMitad = Math.floor(mitadTotalMesesBrutos / 12);
                        const mesesMitadDecimal = mitadTotalMesesBrutos % 12;
                        const diasMitad = Math.floor(pDias / 2);
                        const diasDeMesesDecimales = Math.floor((mesesMitadDecimal - Math.floor(mesesMitadDecimal)) * 30.44);
                        
                        let fechaMitadBruta = new Date(fechaInicioCondena);
                        fechaMitadBruta.setUTCFullYear(fechaMitadBruta.getUTCFullYear() + anosMitad);
                        fechaMitadBruta.setUTCMonth(fechaMitadBruta.getUTCMonth() + Math.floor(mesesMitadDecimal));
                        fechaMitadBruta.setUTCDate(fechaMitadBruta.getUTCDate() + diasMitad + diasDeMesesDecimales);

                        let fechaMitadPena = new Date(fechaMitadBruta);
                        fechaMitadPena.setUTCDate(fechaMitadPena.getUTCDate() - diasDetencionPreventiva);

                        // B. Dos Tercios (2/3) - Método Años/Meses
                        const dosTerciosMesesBrutos = (totalMesesBrutos * 2 / 3);
                        const anosDosTercios = Math.floor(dosTerciosMesesBrutos / 12);
                        const mesesDosTerciosDecimal = dosTerciosMesesBrutos % 12;
                        const diasDosTercios = Math.floor(pDias * 2 / 3);
                        const diasDeMesesDecimalesDosTercios = Math.floor((mesesDosTerciosDecimal - Math.floor(mesesDosTerciosDecimal)) * 30.44);

                        let fechaDosTerciosBruta = new Date(fechaInicioCondena);
                        fechaDosTerciosBruta.setUTCFullYear(fechaDosTerciosBruta.getUTCFullYear() + anosDosTercios);
                        fechaDosTerciosBruta.setUTCMonth(fechaDosTerciosBruta.getUTCMonth() + Math.floor(mesesDosTerciosDecimal));
                        fechaDosTerciosBruta.setUTCDate(fechaDosTerciosBruta.getUTCDate() + diasDosTercios + diasDeMesesDecimalesDosTercios);
                        
                        let fechaDosTerciosPena = new Date(fechaDosTerciosBruta);
                        fechaDosTerciosPena.setUTCDate(fechaDosTerciosPena.getUTCDate() - diasDetencionPreventiva);

                        // C. Ocho Meses - Para LC (<=3 años)
                        const diasOchoMeses = Math.floor((365.25 / 12) * 8); // 243 días
                        const diasRestantesParaOchoMeses = diasOchoMeses - diasDetencionPreventiva;
                        let fechaOchoMeses = sumarDiasAFecha(new Date(fechaInicioCondena), diasRestantesParaOchoMeses);

                        // --- 2. ASIGNACIÓN DE BENEFICIOS SEGÚN REGLAS ---

                        // A. Período de Prueba (Art. 17)
                        // Se calcula solo si el hecho es posterior a 2015 Y NO es delito 56bis
                        if (tipoDelito === 'otro' && esHechoPosterior2015) {
                            beneficios.push({
                                tipo: 'Período de Prueba (Art. 17)',
                                fecha: formatearFecha(fechaMitadPena) // Inicia a la mitad de la pena
                            });
                        } else {
                            if (tipoDelito === 'otro') { // Delito común, pero < 2015
                                alertas.push({
                                    mensaje: 'Hecho anterior a 27/07/2015. No aplica Período de Prueba.',
                                    tipo: 'alerta'
                                });
                            } else { // Delito 56bis, pero < 2017
                                alertas.push({
                                    mensaje: 'Delito Art. 56 bis (hecho ant 27/07/2017): No aplica Período de Prueba.',
                                    tipo: 'alerta'
                                });
                            }
                        }

                        // B. Salidas Transitorias (ST)
                        if (tipoDelito === '56bis') {
                            // Delito Art. 14 CP -> A los 2/3
                            beneficios.push({
                                tipo: 'Salidas Transitorias (Art. 14 CP)',
                                fecha: formatearFecha(fechaDosTerciosPena)
                            });
                        } else {
                            // Delito común -> A la mitad (fechaMitadPena)
                            beneficios.push({
                                tipo: 'Salidas Transitorias (Común)',
                                fecha: formatearFecha(fechaMitadPena)
                            });
                        }
                        
                        // C. Libertad Condicional (LC - Art. 13 y 14)
                        let tieneLibertadCondicional = false;
                        
                        if (reincidente === 'no' && tipoDelito !== '56bis') {
                            let fechaLibertadCondicional;
                            
                            if (pAnos > 3 || (pAnos === 3 && (pMeses > 0 || pDias > 0))) {
                                // Penas > 3 años: 2/3 de la condena
                                fechaLibertadCondicional = fechaDosTerciosPena;
                            } else {
                                // Penas <= 3 años: 8 meses de prisión cumplida
                                fechaLibertadCondicional = fechaOchoMeses;
                            }
                            
                            beneficios.push({
                                tipo: 'Libertad Condicional (Art. 13)',
                                fecha: formatearFecha(fechaLibertadCondicional)
                            });
                            tieneLibertadCondicional = true;

                        } else {
                            // Alerta si es reincidente
                            if (reincidente === 'si') {
                                alertas.push({
                                    mensaje: 'No puede acceder a Libertad Condicional por ser Reincidente (Art. 14 CP)',
                                    tipo: 'error'
                                });
                            }
                            // RE-AÑADIMOS la alerta de '56bis'
                            if (tipoDelito === '56bis') {
                                 alertas.push({
                                    mensaje: 'No puede acceder a Libertad Condicional por el tipo de delito (Art. 14 CP / Art. 56 bis LEP)',
                                    tipo: 'error'
                                });
                            }
                        }

                        // D. Libertad Asistida (Art. 54)
                        // Se concede si NO tiene Libertad Condicional
                        if (!tieneLibertadCondicional) {
                            
                            let mesesAntes;
                            if (esHechoPosterior2015) {
                                // Posterior a la ley: 3 meses
                                mesesAntes = 3;
                            } else {
                                // Anterior a la ley: 6 meses
                                mesesAntes = 6;
                            }
                            
                            const fechaLibertadAsistida = sumarMesesAFecha(new Date(fechaFinCondena), -mesesAntes);
                            beneficios.push({
                                tipo: 'Libertad Asistida (Art. 54)',
                                fecha: formatearFecha(fechaLibertadAsistida)
                            });
                        }
                    }
                }
            }
            
            // 4. GUARDAR Y MOSTRAR RESULTADOS
            lastResults = {
                nombreCondenado,
                delito,
                fechaHecho: formatearFecha(fechaHecho),
                reincidente: reincidente === 'si',
                tipoCondena,
                penaTotalDias,
                penaEfectivaDias,
                fechaFinCondena: fechaFinCondena ? formatearFecha(fechaFinCondena) : 'No aplica',
                beneficios,
                alertas
            };
            
            mostrarResultados(lastResults);
        }
        
        function mostrarResultados(resultados) {
            const resultadosDiv = document.getElementById('resultados');
            const container = document.getElementById('resultadosContainer');
            
            let html = `
                <div class="resultado-item">
                    <strong>Nombre del condenado:</strong> ${resultados.nombreCondenado}
                </div>
                <div class="resultado-item">
                    <strong>Delito:</strong> ${resultados.delito}
                </div>
                <div class="resultado-item">
                    <strong>Fecha del hecho:</strong> ${resultados.fechaHecho}
                </div>
                <div class="resultado-item">
                    <strong>Reincidente:</strong> ${resultados.reincidente ? 'Sí' : 'No'}
                </div>
                <div class="resultado-item">
                    <strong>Tipo de condena:</strong> ${resultados.tipoCondena === 'temporal' ? 'Prisión efectiva temporal' : 'Prisión efectiva perpetua'}
                </div>
            `;
            
            if (resultados.tipoCondena === 'temporal') {
                const diasDetencion = resultados.penaTotalDias - resultados.penaEfectivaDias;
                html += `
                    <div class="resultado-item">
                        <strong>Pena total impuesta:</strong> ${convertirDiasAMDM(resultados.penaTotalDias)}
                    </div>
                    <div class="resultado-item">
                        <strong>Días de detención preventiva:</strong> ${convertirDiasAMDM(diasDetencion)} (${diasDetencion} días)
                    </div>
                    <div class="resultado-item">
                        <strong>Pena efectiva a cumplir:</strong> ${convertirDiasAMDM(resultados.penaEfectivaDias)}
                    </div>
                    <div class="resultado-item">
                        <strong>Fecha de fin de condena:</strong> ${resultados.fechaFinCondena}
                    </div>
                `;
            }
            
            if (resultados.beneficios.length > 0) {
                html += '<h3>Beneficios Posibles:</h3>';
                const order = {
                    "Período de Prueba (Art. 17)": 1,
                    "Salidas Transitorias (Común)": 2,
                    "Salidas Transitorias (Art. 14 CP)": 3,
                    "Libertad Condicional (Art. 13)": 4,
                    "Libertad Asistida (Art. 54)": 5,
                    "Régimen Preparatorio (Art. 56 quater)": 6
                };
                resultados.beneficios.sort((a, b) => {
                    const orderA = order[a.tipo] || 99;
                    const orderB = order[b.tipo] || 99;
                    return orderA - orderB;
                });
                resultados.beneficios.forEach(beneficio => {
                    html += `
                        <div class="resultado-item beneficio-item">
                            <strong>${beneficio.tipo}:</strong> ${beneficio.fecha}
                        </div>
                    `;
                });
            }
            if (resultados.alertas.length > 0) {
                html += '<h3>Información Importante:</h3>';
                resultados.alertas.forEach(alerta => {
                    const clase = alerta.tipo === 'error' ? 'error-item' : 'alerta-item';
                    html += `
                        <div class="resultado-item ${clase}">
                            ${alerta.mensaje}
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            resultadosDiv.classList.remove('hidden');
            resultadosDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function generarPDF() {
            try {
                const contenido = document.getElementById('resultadosContainer').innerHTML;
                if (!contenido) {
                    alert('No hay resultados para generar el PDF');
                    return;
                }
                
                const ventana = window.open('', '_blank');
                
                if (!ventana) {
                    alert('No se pudo abrir una nueva ventana. Por favor, permita las ventanas emergentes para este sitio y vuelva a intentarlo.');
                    return;
                }
                
                ventana.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Informe de Cómputo de Condena</title>
                        <style>
                             body { 
                                 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                 margin: 20px; 
                                 font-size: 14px;
                                 color: #333;
                             }
                             h1 { 
                                 color: #003366;
                                 text-align: center;
                                 font-size: 24px;
                                 margin-bottom: 10px;
                                 text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
                             }
                             h2 { 
                                 color: #003366;
                                 font-size: 18px;
                                 margin-top: 20px;
                                 margin-bottom: 15px;
                                 border-bottom: 1px solid #0066cc;
                                 padding-bottom: 5px;
                                 text-align: center;
                             }
                             .resultado-item { 
                                 margin-bottom: 15px; 
                                 padding: 15px; 
                                 border: 1px solid #ddd; 
                                 border-radius: 5px;
                                 background: white;
                                 box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                             }
                             .beneficio-item { 
                                background-color: #d4edda; 
                                 border-left: 4px solid #27ae60;
                             }
                             .alerta-item { 
                                background-color: #fff3cd; 
                                 border-left: 4px solid #ffc107;
                             }
                             .error-item { 
                                background-color: #f8d7da; 
                                 border-left: 4px solid #dc3545;
                             }
                             strong { 
                                 color: #003366;
                                 font-weight: bold;
                             }
                             .footer {
                                 margin-top: 40px;
                                 font-size: 12px;
                                 color: #666;
                                 border-top: 1px solid #ddd;
                                 padding-top: 10px;
                                 display: flex;
                                 justify-content: space-between;
                                 align-items: center;
                             }
                             .print-btn {
                                 display: block;
                                 margin: 20px auto;
                                 padding: 10px 20px;
                                 background: #0066cc;
                                 color: white;
                                 border: none;
                                 border-radius: 5px;
                                 cursor: pointer;
                                 font-size: 16px;
                                 font-weight: bold;
                             }
                             @media print {
                                 .print-btn { display: none; }
                             }
                        </style>
                    </head>
                    <body>
                        <h1>Informe de Cómputo de Condena</h1>
                        ${contenido}
                        <div class="footer">
                             <p style="margin: 0;">Generado el ${new Date().toLocaleDateString('es-AR')}</p>
                             <p style="margin: 0;">Create by RBM 2025</p>
                        </div>
                        <button class="print-btn" onclick="window.print()">Imprimir Documento</button>
                    </body>
                    </html>
                `);
                
                ventana.document.close();
                ventana.focus();
                
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Ocurrió un error al generar el PDF. Por favor, intente nuevamente.');
            }
        }
    </script>
</body>
</html>
