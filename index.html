<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juzgado de Ejecución Penal de Segunda Nominación de la Prov. de Catamarca, Rep. Argentina</title>
    <!-- Scripts de la API de Google -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        /* --- ESTILOS GENERALES Y FUENTE --- */
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-sizing: border-box;
        }
        
        /* --- FONDO Y CUERPO DE LA PÁGINA --- */
        body {
            background: linear-gradient(135deg, #2c3e50, #34495e); /* Gradiente más sutil y moderno */
            min-height: 100vh;
            padding: 20px;
            color: #333;
            display: flex;
            justify-content: center;
            /* Se elimina align-items: center para que el contenido comience desde arriba */
        }
        
        /* --- CONTENEDOR PRINCIPAL CON EFECTO 3D --- */
        .container {
            width: 100%;
            max-width: 900px;
            margin: 20px;
            background: #ffffff;
            border-radius: 20px; /* Bordes más redondeados */
            box-shadow: 0 20px 50px rgba(0,0,0,0.4), 0 0 0 2px rgba(255,255,255,0.1); /* Sombra más pronunciada para efecto 3D */
            overflow: hidden;
            transform: perspective(1200px); /* Perspectiva para transformaciones 3D */
            transition: transform 0.4s ease;
        }

        .container:hover {
            transform: scale(1.01); /* Ligero zoom al pasar el mouse */
        }
        
        /* --- ENCABEZADO CON LOGO Y TÍTULO --- */
        .header {
            background: linear-gradient(90deg, #003366, #005cb3);
            color: white;
            padding: 20px 40px; /* Ajuste de padding */
            text-align: center;
            position: relative; /* Necesario para posicionar el logo */
            border-bottom: 5px solid #fdbb2d;
            min-height: 120px; /* Altura mínima para asegurar espacio */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .header-logo {
            position: absolute;
            top: 50%;
            left: 40px;
            transform: translateY(-50%);
            width: 80px; /* Tamaño del logo */
            height: auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            padding: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }

        /* Contenedor para el texto del encabezado para gestionar el espaciado */
        .header-text-container {
            padding-left: 100px; /* Espacio para que no choque con el logo */
            padding-right: 40px;
        }
        
        .header h1 {
            margin: 0 0 5px 0;
            font-size: 1.5rem; /* Ajuste de tamaño para el título largo */
            font-weight: 500;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .header p {
            margin: 0;
            opacity: 1;
            font-size: 2rem; /* Tamaño más grande para "Cómputo de Pena" */
            font-weight: bold;
            text-shadow: 0 3px 8px rgba(0,0,0,0.5);
            letter-spacing: 1px;
        }
        
        /* --- CONTENIDO PRINCIPAL --- */
        .content {
            padding: 30px;
        }
        
        /* --- SECCIONES DEL FORMULARIO CON EFECTO HOVER --- */
        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            border: none; /* Quitamos el borde */
            border-radius: 15px;
            background: #f9fafb;
            box-shadow: 0 5px 15px rgba(0,0,0,0.07); /* Sombra sutil */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-5px); /* Se eleva al pasar el mouse */
            box-shadow: 0 12px 25px rgba(0,0,0,0.1);
        }
        
        .form-section h2 {
            margin-top: 0;
            color: #003366;
            border-bottom: 2px solid #005cb3;
            padding-bottom: 10px;
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 1rem;
        }
        
        /* --- INPUTS Y SELECTS MODERNOS --- */
        input,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #0066cc;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2); /* Resplandor al enfocar */
        }
        
        .periodo-detencion {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .periodo-detencion input {
            flex: 1;
        }
        
        /* --- BOTONES CON EFECTO 3D --- */
        .btn {
            background: linear-gradient(145deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 91, 179, 0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            background: linear-gradient(145deg, #0069d9, #004a99);
            transform: translateY(-3px) scale(1.05); /* Efecto de elevación y crecimiento */
            box-shadow: 0 7px 15px rgba(0, 91, 179, 0.4);
        }

        .btn:active {
            transform: translateY(-1px) scale(1.02); /* Efecto de presionar */
        }
        
        .btn-danger {
            background: linear-gradient(145deg, #dc3545, #b02a37);
            box-shadow: 0 4px 10px rgba(176, 42, 55, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(145deg, #c82333, #a12430);
            box-shadow: 0 7px 15px rgba(176, 42, 55, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(145deg, #28a745, #1e7e34);
            font-size: 1.3rem;
            padding: 15px 30px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(30, 126, 52, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(145deg, #218838, #19692c);
            box-shadow: 0 7px 15px rgba(30, 126, 52, 0.4);
        }
        
        .btn-pdf {
            background: linear-gradient(145deg, #8e44ad, #7d3c98);
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(125, 60, 152, 0.3);
        }
        
        .btn-pdf:hover {
            background: linear-gradient(145deg, #803ea5, #6d3284);
            box-shadow: 0 7px 15px rgba(125, 60, 152, 0.4);
        }
        
        /* --- SECCIÓN DE RESULTADOS --- */
        .resultados {
            margin-top: 30px;
            padding: 25px;
            background: #eef2f7;
            border-radius: 15px;
            border-left: 6px solid #005cb3;
        }
        
        .resultados h2 {
            color: #003366;
            margin-top: 0;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .resultados h3 {
            color: #003366;
            font-size: 1.4rem;
            margin-top: 25px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .resultado-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            font-size: 1.05rem;
            border-left: 4px solid transparent;
            transition: border-color 0.3s;
        }

        .resultado-item:hover {
            border-left-color: #007bff;
        }
        
        .resultado-item strong {
            color: #003366;
            font-weight: 600;
            font-size: 1.1rem;
            margin-right: 8px;
        }
        
        .beneficio-item {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .alerta-item {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .error-item {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        /* --- PIE DE PÁGINA --- */
        .footer {
            background: #2c3e50;
            color: rgba(255,255,255,0.8);
            text-align: center;
            padding: 20px;
            border-top: 5px solid #fdbb2d;
        }
        
        .footer p {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .hidden {
            display: none;
        }
        
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-size: 1rem;
            color: #0c5460;
        }

        /* --- ESTILOS PARA EL MODAL DE CONFIRMACIÓN --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content h3 {
            margin-top: 0;
            color: #333;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        /* --- RESPONSIVIDAD --- */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 20px;
            }
            .header-logo {
                position: static; /* Cambia a estático en móvil */
                transform: none;
                margin-bottom: 15px;
                width: 70px;
            }
            .header-text-container {
                padding-left: 0; /* Sin padding en móvil */
                padding-right: 0;
            }
            .header h1 {
                font-size: 1.2rem;
            }
            .header p {
                font-size: 1.8rem;
            }
            .content {
                padding: 20px;
            }
            .periodo-detencion {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo-poder-judicial.jpeg" alt="Logo Poder Judicial de Catamarca" class="header-logo">
            <div class="header-text-container">
                <h1>Juzgado de Ejecución Penal de Segunda Nominación de la Prov. de Catamarca, Rep. Argentina</h1>
                <p>Cómputo de Pena</p>
            </div>
        </div>
        
        <div class="content">
            <div class="info-box">
                <strong>Información importante:</strong> Esta calculadora aplica la legislación vigente en Argentina (Ley 24.660 y modificaciones).
            </div>
            
            <form id="condenaForm">
                <div class="form-section">
                    <h2>Datos Personales</h2>
                    
                    <div class="form-group">
                        <label for="nombreCondenado">Nombre del condenado:</label>
                        <input type="text" id="nombreCondenado" placeholder="Apellido y Nombre" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="delito">Delito:</label>
                        <input type="text" id="delito" placeholder="Descripción del delito" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Datos de la Condena</h2>
                    
                    <div class="form-group">
                        <label for="tipoCondena">Tipo de condena:</label>
                        <select id="tipoCondena" required>
                            <option value="">Seleccione...</option>
                            <option value="temporal">Prisión efectiva temporal</option>
                            <option value="perpetua">Prisión efectiva perpetua</option>
                        </select>
                    </div>
                    
                    <div id="penaTemporal" class="form-group hidden">
                        <label for="penaImpuesta">Pena impuesta (años, meses, días):</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="penaAnos" placeholder="Años" min="0">
                            <input type="number" id="penaMeses" placeholder="Meses" min="0" max="11">
                            <input type="number" id="penaDias" placeholder="Días" min="0" max="30">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="fechaInicioCondena">Fecha de inicio de condena:</label>
                        <input type="date" id="fechaInicioCondena" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Detenciones Preventivas</h2>
                    <p>Ingrese los períodos de detención previos a la condena (si corresponde):</p>
                    
                    <div id="detencionesContainer">
                        <!-- Este contenedor estará vacío inicialmente -->
                    </div>
                    
                    <button type="button" class="btn" onclick="agregarPeriodo()">+ Agregar período</button>
                </div>
                
                <div class="form-section">
                    <h2>Datos del Hecho</h2>
                    
                    <div class="form-group">
                        <label for="fechaHecho">Fecha del hecho:</label>
                        <input type="date" id="fechaHecho" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipoDelito">Tipo de delito:</label>
                        <select id="tipoDelito" required>
                            <option value="">Seleccione...</option>
                            <option value="56bis">Art. 56 bis (Ley 24.660)</option>
                            <option value="otro">Otro delito</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reincidente">¿Es reincidente (Art. 50 CP)?</label>
                        <select id="reincidente" required>
                            <option value="">Seleccione...</option>
                            <option value="si">Sí</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success">Calcular Condena</button>
            </form>
            
            <div id="resultados" class="resultados hidden">
                <h2>Informe de Cómputo de Condena</h2>
                <div id="resultadosContainer"></div>
                <button id="btnPDF" class="btn btn-pdf">Generar PDF para Imprimir</button>
                <button id="btnGuardarSheets" class="btn" style="background: linear-gradient(145deg, #28a745, #1e7e34);">Guardar en Google Sheets</button>
                <div id="auth-status" style="margin-top: 15px; font-weight: 500;"></div>
            </div>
        </div>
        
        <div class="footer">
            <p>Create by RBM 2025</p>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirmación</h3>
            <p id="modalMessage">¿Está seguro de que desea guardar estos datos en Google Sheets?</p>
            <div class="modal-buttons">
                <button id="confirmBtn" class="btn btn-success">Sí, guardar</button>
                <button id="cancelBtn" class="btn btn-danger">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES PARA LA API DE GOOGLE ---
        // IMPORTANTE: Reemplaza estos valores con tus propias credenciales.
        const CLIENT_ID = '110247006601-hvbpfqcd0v79tgmiqr9ntc853t9a1vu3.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1ASWYg5AZbm1AD5h9cQjxZK00Q8RebiuQo3daBYJnj64';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let lastResults = null; // Variable para guardar los últimos resultados calculados

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('condenaForm').addEventListener('submit', calcularCondena);
            document.getElementById('tipoCondena').addEventListener('change', togglePenaTemporal);
            
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'btnPDF') {
                    generarPDF();
                }
                if (e.target && e.target.id === 'btnGuardarSheets') {
                    mostrarConfirmacion('¿Está seguro de que desea guardar estos datos en Google Sheets?', guardarEnSheets);
                }
            });

            // Eventos del modal
            document.getElementById('cancelBtn').addEventListener('click', ocultarConfirmacion);
            document.getElementById('confirmationModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    ocultarConfirmacion();
                }
            });
        });

        // --- FUNCIONES DE LA API DE GOOGLE ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Se define dinámicamente
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('btnGuardarSheets').disabled = false;
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('auth-status').innerText = '¡Autorizado! Listo para guardar.';
                await guardarEnSheets(); // Intentar guardar de nuevo después de autorizar
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function guardarEnSheets() {
            if (!lastResults) {
                document.getElementById('auth-status').innerText = 'Error: Primero debe calcular una condena.';
                return;
            }

            if (gapi.client.getToken() === null) {
                handleAuthClick();
                return;
            }

            // --- INICIO DE LA MODIFICACIÓN ---
            // Formatear los beneficios en un solo texto
            const beneficiosTexto = lastResults.beneficios.map(b => `${b.tipo}: ${b.fecha}`).join('; ') || 'No aplica';

            // Recopilar todos los datos del informe en el orden correcto
            const datosFila = [
                lastResults.nombreCondenado,
                lastResults.delito,
                lastResults.fechaHecho,
                lastResults.reincidente ? 'Sí' : 'No',
                lastResults.tipoCondena === 'temporal' ? 'Prisión efectiva temporal' : 'Prisión efectiva perpetua',
                convertirDiasAMDM(lastResults.penaTotalDias),
                `${lastResults.penaTotalDias - lastResults.penaEfectivaDias} días`,
                convertirDiasAMDM(lastResults.penaEfectivaDias),
                lastResults.fechaFinCondena,
                beneficiosTexto,
                new Date().toLocaleString('es-AR') // Fecha de guardado
            ];
            
            const request = {
                spreadsheetId: SPREADSHEET_ID,
                range: "'Hoja 1'!A1", // Se usa "'Hoja 1'" para el nombre en español
                valueInputOption: 'USER_ENTERED',
                resource: {
                    values: [datosFila]
                }
            };

            document.getElementById('auth-status').innerText = 'Guardando...';
            gapi.client.sheets.spreadsheets.values.append(request).then(function(response) {
                document.getElementById('auth-status').innerText = '¡Datos guardados con éxito!';
            }, function(reason) {
                console.error('Error al guardar:', reason);
                let errorMessage = 'Error al guardar. Revise la consola para más detalles.';
                if (reason.result && reason.result.error) {
                    const error = reason.result.error;
                    if (error.status === 'NOT_FOUND') {
                        errorMessage = "Error: No se encontró la hoja de cálculo. Verifique que el 'SPREADSHEET_ID' sea correcto.";
                    } else if (error.status === 'PERMISSION_DENIED') {
                        errorMessage = "Error: Permiso denegado. Asegúrese de tener permiso para editar la hoja de cálculo.";
                    } else if (error.message && error.message.includes('Unable to parse range')) {
                        errorMessage = "Error: No se encontró la pestaña. Verifique que el nombre de la pestaña sea exactamente 'Hoja 1'.";
                    } else {
                        errorMessage = `Error: ${error.message}`;
                    }
                }
                document.getElementById('auth-status').innerText = errorMessage;
            });
            // --- FIN DE LA MODIFICACIÓN ---
        }

        // --- FUNCIONES DEL MODAL ---
        function mostrarConfirmacion(message, callback) {
            document.getElementById('modalMessage').textContent = message;
            const modal = document.getElementById('confirmationModal');
            modal.classList.add('visible');

            const confirmBtn = document.getElementById('confirmBtn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', () => {
                callback();
                ocultarConfirmacion();
            });
        }

        function ocultarConfirmacion() {
            document.getElementById('confirmationModal').classList.remove('visible');
        }
        
        // --- FUNCIONES DE LA CALCULADORA (EXISTENTES) ---
        function togglePenaTemporal() {
            const tipoCondena = document.getElementById('tipoCondena').value;
            const penaTemporalDiv = document.getElementById('penaTemporal');
            
            if (tipoCondena === 'temporal') {
                penaTemporalDiv.classList.remove('hidden');
                document.getElementById('penaAnos').required = true;
                document.getElementById('penaMeses').required = true;
                document.getElementById('penaDias').required = true;
            } else {
                penaTemporalDiv.classList.add('hidden');
                document.getElementById('penaAnos').required = false;
                document.getElementById('penaMeses').required = false;
                document.getElementById('penaDias').required = false;
            }
        }
        
        function agregarPeriodo() {
            const container = document.getElementById('detencionesContainer');
            const nuevoPeriodo = document.createElement('div');
            nuevoPeriodo.className = 'periodo-detencion';
            nuevoPeriodo.innerHTML = `
                <input type="date" placeholder="Fecha inicio" class="fechaInicio" required>
                <input type="date" placeholder="Fecha fin" class="fechaFin" required>
                <button type="button" class="btn btn-danger" onclick="eliminarPeriodo(this)">Eliminar</button>
            `;
            container.appendChild(nuevoPeriodo);
        }
        
        function eliminarPeriodo(boton) {
            boton.parentElement.remove();
        }
        
        function convertirDiasAMDM(dias) {
            if (dias < 0) dias = 0;
            const años = Math.floor(dias / 365.25);
            const resto = dias % 365.25;
            const meses = Math.floor(resto / 30.44);
            const diasRestantes = Math.round(resto % 30.44);
            
            let resultado = [];
            if (años > 0) {
                resultado.push(años + ' año' + (años !== 1 ? 's' : ''));
            }
            if (meses > 0) {
                resultado.push(meses + ' mes' + (meses !== 1 ? 'es' : ''));
            }
            if (diasRestantes > 0) {
                resultado.push(diasRestantes + ' día' + (diasRestantes !== 1 ? 's' : ''));
            }
            return resultado.join(', ') || '0 días';
        }
        
        function formatearFecha(fecha) {
            if (!fecha || !(fecha instanceof Date) || isNaN(fecha)) {
                return 'Fecha inválida';
            }
            const dia = fecha.getUTCDate().toString().padStart(2, '0');
            const mes = (fecha.getUTCMonth() + 1).toString().padStart(2, '0');
            const año = fecha.getUTCFullYear();
            return `${dia}/${mes}/${año}`;
        }

        function sumarDiasAFecha(fecha, dias) {
            const nuevaFecha = new Date(fecha);
            nuevaFecha.setUTCDate(nuevaFecha.getUTCDate() + dias);
            return nuevaFecha;
        }
        
        function sumarMesesAFecha(fecha, meses) {
            const nuevaFecha = new Date(fecha);
            nuevaFecha.setUTCMonth(nuevaFecha.getUTCMonth() + meses);
            return nuevaFecha;
        }
        
        function sumarAñosAFecha(fecha, años) {
            const nuevaFecha = new Date(fecha);
            nuevaFecha.setUTCFullYear(nuevaFecha.getUTCFullYear() + años);
            return nuevaFecha;
        }

        function calcularCondena(e) {
            e.preventDefault();
            lastResults = null; // Limpiar resultados previos

            const nombreCondenado = document.getElementById('nombreCondenado').value;
            const delito = document.getElementById('delito').value;
            const tipoCondena = document.getElementById('tipoCondena').value;
            const fechaInicioCondenaStr = document.getElementById('fechaInicioCondena').value;
            const fechaHechoStr = document.getElementById('fechaHecho').value;
            const tipoDelito = document.getElementById('tipoDelito').value;
            const reincidente = document.getElementById('reincidente').value;

            if (!fechaInicioCondenaStr || !fechaHechoStr) {
                const resultadosDiv = document.getElementById('resultados');
                const container = document.getElementById('resultadosContainer');
                container.innerHTML = `<div class="resultado-item error-item"><strong>Error:</strong> Por favor, complete todas las fechas requeridas en el formulario.</div>`;
                resultadosDiv.classList.remove('hidden');
                resultadosDiv.scrollIntoView({ behavior: 'smooth' });
                return;
            }

            const fechaInicioCondena = new Date(fechaInicioCondenaStr + 'T00:00:00Z');
            const fechaHecho = new Date(fechaHechoStr + 'T00:00:00Z');
            
            let penaTotalDias = 0;
            let penaEfectivaDias = 0;
            let fechaFinCondena = null;
            
            if (tipoCondena === 'temporal') {
                const penaAnos = parseInt(document.getElementById('penaAnos').value) || 0;
                const penaMeses = parseInt(document.getElementById('penaMeses').value) || 0;
                const penaDias = parseInt(document.getElementById('penaDias').value) || 0;

                let fechaFinPenaBruta = new Date(fechaInicioCondena);
                fechaFinPenaBruta.setUTCFullYear(fechaFinPenaBruta.getUTCFullYear() + penaAnos);
                fechaFinPenaBruta.setUTCMonth(fechaFinPenaBruta.getUTCMonth() + penaMeses);
                fechaFinPenaBruta.setUTCDate(fechaFinPenaBruta.getUTCDate() + penaDias);
                
                let diasDetencionPreventiva = 0;
                const periodosElements = document.querySelectorAll('.periodo-detencion');
                periodosElements.forEach(periodo => {
                    const fechaInicioStr = periodo.querySelector('.fechaInicio').value;
                    const fechaFinStr = periodo.querySelector('.fechaFin').value;
                    if (fechaInicioStr && fechaFinStr) {
                        const fechaInicio = new Date(fechaInicioStr + 'T00:00:00Z');
                        const fechaFin = new Date(fechaFinStr + 'T00:00:00Z');
                        if (fechaInicio <= fechaFin) {
                            const diffTime = Math.abs(fechaFin - fechaInicio);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                            diasDetencionPreventiva += diffDays;
                        }
                    }
                });

                fechaFinCondena = new Date(fechaFinPenaBruta);
                fechaFinCondena.setUTCDate(fechaFinCondena.getUTCDate() - diasDetencionPreventiva);
                
                const diffPenaTotalMs = fechaFinPenaBruta.getTime() - fechaInicioCondena.getTime();
                penaTotalDias = Math.round(diffPenaTotalMs / (1000 * 60 * 60 * 24));
                if (penaTotalDias < 0) penaTotalDias = 0;

                const diffPenaEfectivaMs = fechaFinCondena.getTime() - fechaInicioCondena.getTime();
                penaEfectivaDias = Math.round(diffPenaEfectivaMs / (1000 * 60 * 60 * 24));
                if (penaEfectivaDias < 0) penaEfectivaDias = 0;
            }
            
            const fechaLimite = new Date('2017-07-28T00:00:00Z');
            const esPosterior = fechaHecho >= fechaLimite;
            
            let beneficios = [];
            let alertas = [];
            
            if (tipoCondena === 'perpetua') {
                alertas.push({
                    mensaje: 'Condena perpetua: No corresponde el acceso a beneficios',
                    tipo: 'error'
                });
            } else if (tipoDelito === '56bis' && esPosterior) {
                const fechaRegimenPreparatorio = sumarAñosAFecha(new Date(fechaFinCondena), -2);
                beneficios.push({
                    tipo: 'Régimen Preparatorio de Libertad (Art. 56 quater)',
                    fecha: formatearFecha(fechaRegimenPreparatorio)
                });
                alertas.push({
                    mensaje: 'No puede acceder a otros beneficios por ser delito del Art. 56 bis con hecho posterior al 28/07/2017',
                    tipo: 'alerta'
                });
            } else if (tipoCondena === 'temporal') {
                if (!esPosterior) {
                    const fechaSalidasTransitorias = sumarDiasAFecha(new Date(fechaInicioCondena), Math.floor(penaEfectivaDias / 2));
                    beneficios.push({
                        tipo: 'Salidas Transitorias',
                        fecha: formatearFecha(fechaSalidasTransitorias)
                    });
                } else {
                    const fechaPeriodoPrueba = sumarDiasAFecha(new Date(fechaInicioCondena), Math.floor(penaEfectivaDias / 2));
                    beneficios.push({
                        tipo: 'Período de Prueba',
                        fecha: formatearFecha(fechaPeriodoPrueba)
                    });
                    
                    let fechaSalidasTransitorias = new Date(fechaPeriodoPrueba);
                    if (penaTotalDias > 3650) {
                        fechaSalidasTransitorias = sumarAñosAFecha(fechaSalidasTransitorias, 1);
                    } else if (penaTotalDias > 1825) {
                        fechaSalidasTransitorias = sumarMesesAFecha(fechaSalidasTransitorias, 6);
                    }
                    beneficios.push({
                        tipo: 'Salidas Transitorias',
                        fecha: formatearFecha(fechaSalidasTransitorias)
                    });
                }
                
                let tieneLibertadCondicional = false;
                if (reincidente === 'no') {
                    let fechaLibertadCondicional;
                    if (penaTotalDias > 1095) {
                        const fraccionCondena = Math.floor(penaEfectivaDias * 2 / 3);
                        fechaLibertadCondicional = sumarDiasAFecha(new Date(fechaInicioCondena), fraccionCondena);
                    } else {
                        fechaLibertadCondicional = sumarMesesAFecha(new Date(fechaInicioCondena), 8);
                    }
                    beneficios.push({
                        tipo: 'Libertad Condicional',
                        fecha: formatearFecha(fechaLibertadCondicional)
                    });
                    tieneLibertadCondicional = true;
                } else {
                    alertas.push({
                        mensaje: 'No puede acceder a libertad condicional por ser reincidente (Art. 50 CP)',
                        tipo: 'error'
                    });
                }
                
                if (!tieneLibertadCondicional) {
                    const mesesAntes = esPosterior ? 3 : 6;
                    const fechaLibertadAsistida = sumarMesesAFecha(new Date(fechaFinCondena), -mesesAntes);
                    beneficios.push({
                        tipo: 'Libertad Asistida',
                        fecha: formatearFecha(fechaLibertadAsistida)
                    });
                }
            }
            
            lastResults = {
                nombreCondenado,
                delito,
                fechaHecho: formatearFecha(fechaHecho),
                reincidente: reincidente === 'si',
                tipoCondena,
                penaTotalDias,
                penaEfectivaDias,
                fechaFinCondena: fechaFinCondena ? formatearFecha(fechaFinCondena) : 'No aplica',
                beneficios,
                alertas
            };
            
            mostrarResultados(lastResults);
        }
        
        function mostrarResultados(resultados) {
            const resultadosDiv = document.getElementById('resultados');
            const container = document.getElementById('resultadosContainer');
            
            let html = `
                <div class="resultado-item">
                    <strong>Nombre del condenado:</strong> ${resultados.nombreCondenado}
                </div>
                <div class="resultado-item">
                    <strong>Delito:</strong> ${resultados.delito}
                </div>
                <div class="resultado-item">
                    <strong>Fecha del hecho:</strong> ${resultados.fechaHecho}
                </div>
                <div class="resultado-item">
                    <strong>Reincidente:</strong> ${resultados.reincidente ? 'Sí' : 'No'}
                </div>
                <div class="resultado-item">
                    <strong>Tipo de condena:</strong> ${resultados.tipoCondena === 'temporal' ? 'Prisión efectiva temporal' : 'Prisión efectiva perpetua'}
                </div>
            `;
            
            if (resultados.tipoCondena === 'temporal') {
                html += `
                    <div class="resultado-item">
                        <strong>Pena total impuesta:</strong> ${convertirDiasAMDM(resultados.penaTotalDias)}
                    </div>
                    <div class="resultado-item">
                        <strong>Días de detención preventiva:</strong> ${resultados.penaTotalDias - resultados.penaEfectivaDias} días
                    </div>
                    <div class="resultado-item">
                        <strong>Pena efectiva a cumplir:</strong> ${convertirDiasAMDM(resultados.penaEfectivaDias)}
                    </div>
                    <div class="resultado-item">
                        <strong>Fecha de fin de condena:</strong> ${resultados.fechaFinCondena}
                    </div>
                `;
            }
            
            if (resultados.beneficios.length > 0) {
                html += '<h3>Beneficios Posibles:</h3>';
                resultados.beneficios.sort((a, b) => new Date(a.fecha.split('/').reverse().join('-')) - new Date(b.fecha.split('/').reverse().join('-')));
                resultados.beneficios.forEach(beneficio => {
                    html += `
                        <div class="resultado-item beneficio-item">
                            <strong>${beneficio.tipo}:</strong> ${beneficio.fecha}
                        </div>
                    `;
                });
            }

            if (resultados.alertas.length > 0) {
                html += '<h3>Información Importante:</h3>';
                resultados.alertas.forEach(alerta => {
                    const clase = alerta.tipo === 'error' ? 'error-item' : 'alerta-item';
                    html += `
                        <div class="resultado-item ${clase}">
                            ${alerta.mensaje}
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            resultadosDiv.classList.remove('hidden');
            resultadosDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function generarPDF() {
            try {
                const contenido = document.getElementById('resultadosContainer').innerHTML;
                if (!contenido) {
                    alert('No hay resultados para generar el PDF');
                    return;
                }
                
                const ventana = window.open('', '_blank');
                
                if (!ventana) {
                    alert('No se pudo abrir una nueva ventana. Por favor, permita las ventanas emergentes para este sitio y vuelva a intentarlo.');
                    return;
                }
                
                ventana.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Informe de Cómputo de Condena</title>
                        <style>
                             body { 
                                 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                 margin: 20px; 
                                 font-size: 14px;
                                 color: #333;
                             }
                             h1 { 
                                 color: #003366;
                                 text-align: center;
                                 font-size: 24px;
                                 margin-bottom: 10px;
                                 text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
                             }
                             h2 { 
                                 color: #003366;
                                 font-size: 18px;
                                 margin-top: 20px;
                                 margin-bottom: 15px;
                                 border-bottom: 1px solid #0066cc;
                                 padding-bottom: 5px;
                                 text-align: center;
                             }
                             .resultado-item { 
                                 margin-bottom: 15px; 
                                 padding: 15px; 
                                 border: 1px solid #ddd; 
                                 border-radius: 5px;
                                 background: white;
                                 box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                             }
                             .beneficio-item { 
                                background-color: #d4edda; 
                                 border-left: 4px solid #27ae60;
                             }
                             .alerta-item { 
                                background-color: #fff3cd; 
                                 border-left: 4px solid #ffc107;
                             }
                             .error-item { 
                                background-color: #f8d7da; 
                                 border-left: 4px solid #dc3545;
                             }
                             strong { 
                                 color: #003366;
                                 font-weight: bold;
                             }
                             .footer {
                                 margin-top: 40px;
                                 font-size: 12px;
                                 color: #666;
                                 border-top: 1px solid #ddd;
                                 padding-top: 10px;
                                 display: flex;
                                 justify-content: space-between;
                                 align-items: center;
                             }
                             .print-btn {
                                 display: block;
                                 margin: 20px auto;
                                 padding: 10px 20px;
                                 background: #0066cc;
                                 color: white;
                                 border: none;
                                 border-radius: 5px;
                                 cursor: pointer;
                                 font-size: 16px;
                                 font-weight: bold;
                             }
                             @media print {
                                 .print-btn { display: none; }
                             }
                        </style>
                    </head>
                    <body>
                        <h1>Informe de Cómputo de Condena</h1>
                        ${contenido}
                        <div class="footer">
                             <p style="margin: 0;">Generado el ${new Date().toLocaleDateString('es-AR')}</p>
                             <p style="margin: 0;">Create by RBM 2025</p>
                        </div>
                        <button class="print-btn" onclick="window.print()">Imprimir Documento</button>
                    </body>
                    </html>
                `);
                
                ventana.document.close();
                ventana.focus();
                
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Ocurrió un error al generar el PDF. Por favor, intente nuevamente.');
            }
        }
    </script>
</body>
</html>
